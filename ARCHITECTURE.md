# Crosswalk - Architecture & Setup Guide

## Overview

Crosswalk is a location-based messaging iOS app built with CapacitorJS v8. Users can "drop" messages at their current location on a map, and other users can read those messages when they come within 5 meters of the drop location.

## Tech Stack

### Frontend (`/frontend`)

- **Framework**: React 19 with TypeScript
- **Build Tool**: Vite 7
- **Styling**: Tailwind CSS v4
- **Mobile**: CapacitorJS v8 (iOS)
- **Maps**: MapLibre GL JS (open-source, uses CARTO dark matter tiles)
- **State Management**: Zustand
- **Authentication**: Sign in with Apple via `@capacitor-community/apple-sign-in`
- **Location**: `@capacitor/geolocation` for live GPS tracking

### Backend (`/backend`)

- **Runtime**: Bun
- **Framework**: Hono (fast, lightweight)
- **Database**: SQLite via `bun:sqlite` with Drizzle ORM
- **Auth**: Apple Sign in token verification with `jose`

## Project Structure

```
crosswalk-vibed/
├── frontend/
│   ├── src/
│   │   ├── components/
│   │   │   ├── AuthScreen.tsx      # Sign in with Apple UI
│   │   │   ├── MapView.tsx         # Main map with drops
│   │   │   ├── DropMarker.tsx      # Map marker components
│   │   │   ├── MessageDrawer.tsx   # Bottom drawer for reading drops
│   │   │   └── DropComposer.tsx    # Modal for creating new drops
│   │   ├── hooks/
│   │   │   ├── useLocation.ts      # Live location tracking
│   │   │   ├── useDrops.ts         # Fetch/create drops
│   │   │   └── useAuth.ts          # Auth state management
│   │   ├── stores/
│   │   │   └── app.ts              # Zustand store
│   │   ├── services/
│   │   │   ├── api.ts              # Backend API client
│   │   │   └── distance.ts         # Haversine distance calc
│   │   ├── types/
│   │   │   └── index.ts            # TypeScript types
│   │   ├── App.tsx
│   │   ├── main.tsx
│   │   ├── index.css
│   │   └── vite-env.d.ts
│   ├── ios/                        # Generated by `npx cap add ios`
│   ├── dist/                       # Build output
│   ├── index.html
│   ├── vite.config.ts
│   ├── capacitor.config.ts
│   ├── tsconfig.json
│   └── package.json
├── backend/
│   ├── src/
│   │   ├── routes/
│   │   │   ├── auth.ts             # Apple Sign in endpoints
│   │   │   └── drops.ts            # CRUD for drops
│   │   ├── db/
│   │   │   ├── schema.ts           # Drizzle schema
│   │   │   └── index.ts            # DB connection (bun:sqlite)
│   │   ├── middleware/
│   │   │   └── auth.ts             # JWT verification
│   │   └── index.ts                # Hono app entry
│   ├── data/
│   │   └── crosswalk.db            # SQLite database
│   ├── drizzle.config.ts
│   ├── package.json
│   └── tsconfig.json
├── .gitignore
├── .nvmrc                          # Node 22.19.0 required
└── ARCHITECTURE.md
```

## Key Features

### 1. Sign in with Apple

- Uses `@capacitor-community/apple-sign-in` plugin
- Backend verifies Apple identity token via JWKS
- Issues JWT for subsequent API calls (30-day expiry)

### 2. Live Location Tracking

- Uses `@capacitor/geolocation` with high accuracy mode
- Continuous `watchPosition` for real-time updates
- Required iOS permissions in Info.plist:
  - `NSLocationWhenInUseUsageDescription`
  - `NSLocationAlwaysAndWhenInUseUsageDescription`

### 3. MapLibre GL JS Map

- Uses free CARTO dark matter tiles (no API key needed)
- Dark theme styling matching app aesthetic
- Custom markers for drops (orange gradient) and user (blue pulsing)
- Smooth fly-to animations for location updates

### 4. Proximity-Based Message Reading

- Haversine formula calculates distance between user and drops
- 5-meter threshold for "nearby" drops
- Nearby drops can be tapped to reveal message in bottom drawer
- Far drops show "too far away" with distance

### 5. Message Drops

- Users compose short messages (280 char limit like Twitter)
- Drop is placed at current GPS coordinates
- Drops are visible to all users on the map
- Only readable when within 5 meters

## Setup Commands

### Prerequisites

- Node.js 22.19.0+ (use `nvm use` with .nvmrc)
- Xcode 15+ for iOS builds
- Bun runtime for backend (`curl -fsSL https://bun.sh/install | bash`)

### Frontend Setup

```bash
cd frontend
yarn install
yarn dev                    # Start dev server at :5173
yarn build                  # Build for production
npx cap add ios            # Add iOS platform (first time)
npx cap sync               # Sync web assets to iOS
npx cap open ios           # Open in Xcode
```

### Backend Setup

```bash
cd backend
bun install
bun run db:push            # Push schema to SQLite
bun run dev                # Start dev server at :3000
```

## Environment Variables

### Frontend (`frontend/.env`)

```
VITE_API_URL=http://localhost:3000
VITE_DEV_BYPASS_AUTH=true   # Skip auth in dev mode (optional)
```

### Backend

Set via environment or `.env` file:

```
JWT_SECRET=your-secret-key-change-in-production
```

## iOS Configuration

After running `npx cap add ios`:

### Required Capabilities (in Xcode > Signing & Capabilities)

- Sign in with Apple
- Background Modes > Location updates (optional, for background tracking)

### Info.plist Additions

```xml
<key>NSLocationWhenInUseUsageDescription</key>
<string>Crosswalk needs your location to show nearby message drops and let you create new ones.</string>
<key>NSLocationAlwaysAndWhenInUseUsageDescription</key>
<string>Crosswalk uses your location to notify you of nearby drops even when the app is in the background.</string>
```

## API Endpoints

### Auth

| Method | Path          | Description                           |
| ------ | ------------- | ------------------------------------- |
| POST   | `/auth/apple` | Exchange Apple identity token for JWT |
| GET    | `/auth/me`    | Get current authenticated user        |

### Drops

| Method | Path                             | Description                       |
| ------ | -------------------------------- | --------------------------------- |
| GET    | `/drops?lat=X&lng=Y&radius=1000` | Get drops within radius (meters)  |
| POST   | `/drops`                         | Create a new drop (requires auth) |
| GET    | `/drops/:id`                     | Get single drop by ID             |

## Database Schema

### Users

| Column        | Type | Description                    |
| ------------- | ---- | ------------------------------ |
| id            | TEXT | Primary key (UUID)             |
| apple_user_id | TEXT | Apple's unique user identifier |
| email         | TEXT | User's email (optional)        |
| name          | TEXT | User's display name (optional) |
| created_at    | TEXT | ISO timestamp                  |

### Drops

| Column     | Type | Description                  |
| ---------- | ---- | ---------------------------- |
| id         | TEXT | Primary key (UUID)           |
| user_id    | TEXT | Foreign key to users         |
| message    | TEXT | Drop content (max 280 chars) |
| latitude   | REAL | GPS latitude                 |
| longitude  | REAL | GPS longitude                |
| created_at | TEXT | ISO timestamp                |

## Design System

### Colors (defined in `src/index.css`)

| Name     | Hex     | Usage                       |
| -------- | ------- | --------------------------- |
| ink      | #0a0a0a | Main background             |
| paper    | #fafaf9 | Primary text                |
| charcoal | #1c1c1e | Cards, bottom bar           |
| graphite | #2c2c2e | Borders                     |
| smoke    | #8e8e93 | Muted text                  |
| ember    | #ff6b35 | Primary accent              |
| rust     | #d4501e | Secondary accent, gradients |

### Typography

- Display: SF Pro Display / -apple-system / system-ui
- Mono: SF Mono / ui-monospace

### Key UI Components

- **AuthScreen**: Centered card with app icon, title, tagline, and Sign in with Apple button
- **MapView**: Full-screen map with floating header, recenter button, and bottom action bar
- **MessageDrawer**: Bottom sheet with drag handle, user info, and message content
- **DropComposer**: Bottom sheet with textarea, character counter, and action buttons

## Development Notes

### Testing Without iOS Device

Set `VITE_DEV_BYPASS_AUTH=true` in frontend `.env` to skip auth and go directly to map view.

### Map Not Loading?

The CARTO dark matter tiles require network access. Ensure you're online and check browser console for errors.

### Sign in with Apple Not Working?

Sign in with Apple has different requirements for native iOS vs web:

#### For Native iOS (Recommended)

1. Apple Developer account ($99/year)
2. Create an App ID in Certificates, Identifiers & Profiles with bundle ID `com.crosswalk.app`
3. Enable "Sign in with Apple" capability for the App ID
4. In Xcode, add "Sign in with Apple" capability under Signing & Capabilities
5. Build and run on a real device or simulator

#### For Web Testing (Requires Additional Setup)

Web Sign in with Apple requires a Service ID:

1. In Apple Developer > Certificates, Identifiers & Profiles:

   - Create a new **Services ID** (e.g., `com.crosswalk.app.web`)
   - Enable "Sign in with Apple"
   - Configure domains: add your domain (e.g., `localhost` for dev)
   - Add return URLs: `http://localhost:5173/auth/callback`

2. Create a **Key** for Sign in with Apple:

   - Download the `.p8` private key file
   - Note the Key ID

3. Set frontend env vars:
   ```
   VITE_APPLE_CLIENT_ID=com.crosswalk.app.web
   VITE_APPLE_REDIRECT_URI=http://localhost:5173/auth/callback
   ```

**Note**: For local development, it's easier to use `VITE_DEV_BYPASS_AUTH=true` to skip auth entirely, then test Sign in with Apple on a real iOS device.
